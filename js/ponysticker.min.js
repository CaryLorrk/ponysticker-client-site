var PonyModule=function(){function e(e,t){var n={};for(var o in e)e.hasOwnProperty(o)&&t.hasOwnProperty(o)&&(n[o]=!0);return n}function t(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=!0);return e}function n(e){var t=function(t){return t[e]};return t.$inject=["$stateParams"],t}function o(e){var t=function(t){return parseInt(t[e])};return t.$inject=["$stateParams"],t}function r(e){return!(!e||0>=e||e%1)}function a(e){var t,n=0;for(t in e)e.hasOwnProperty(t)&&n++;return n}function i(){c()}function c(){var e=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,t="undefined"!=typeof InstallTrigger,n=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,o=!!window.chrome&&!s.isOpera,r=!1||!!document.documentMode;s.isOpera=function(){return e},s.isFirefox=function(){return t},s.isSafari=function(){return n},s.isChrome=function(){return o},s.isIE=function(){return r}}var s={};return s.isPositiveInteger=r,s.resolveParamFactory=n,s.resolveIntParamFactory=o,s.objSize=a,s.objIntersection=e,s.objUnionInPlace=t,window.onload=function(){s.saveData=function(){var e=document.createElement("a");return document.body.appendChild(e),e.style="display: none",function(t,n){console.log(t);var o=JSON.stringify(t),r=new Blob([o],{type:"octet/stream"}),a=window.URL.createObjectURL(r);e.href=a,e.download=n,e.click(),window.URL.revokeObjectURL(a)}}()},i(),s}();!function(){function e(e,t,n){e.views.transition("none"),t.useLoader("$translatePartialLoader",{urlTemplate:"i18n/{part}/{lang}.json"}),n.when("/local/package","/local/package/package").when("/local/sticker","/local/sticker/sticker").when("/favorite/package","/favorite/package/package").when("/favorite/sticker","/favorite/sticker/sticker").otherwise("/local/sticker/sticker")}function t(e,t,n,o,r){t.ready(function(){ionic.Platform.isWebView()?(e.intentType="main",window.PonyPlugin.checkIntent(function(t){e.intentType=t})):e.intentType="browser",r.init()}),n.use(o.getLanguage())}angular.module("ponysticker",["ionic","ngCordova","pascalprecht.translate","angularFileUpload","ponysticker.utilites","ponysticker.menu","ponysticker.favorite","ponysticker.local","ponysticker.package","ponysticker.download","ponysticker.tags","ponysticker.preference"]).config(e).run(t),e.$inject=["$ionicConfigProvider","$translateProvider","$urlRouterProvider"],t.$inject=["$rootScope","$ionicPlatform","$translate","preference","database"]}(),function(){function e(e){e.state("download",{url:"/download/:repo",templateUrl:"templates/download.html",controller:"DownloadController as download",resolve:{repo:PonyModule.resolveParamFactory("repo")}})}function t(e,t){t.addPart("download"),e.refresh()}angular.module("ponysticker.download",[]).config(e).run(t),e.$inject=["$stateProvider"],t.$inject=["$translate","$translatePartialLoader"]}(),function(){function e(e){e.state("favorite",{url:"/favorite/:type",templateUrl:"templates/favorite.html",controller:"FavoriteController as favorite",resolve:{type:PonyModule.resolveParamFactory("type")}}).state("favorite.package",{url:"/package",templateUrl:"templates/favorite-package.html",controller:"LocalPackageController as package"}).state("favorite.sticker",{url:"/sticker",templateUrl:"templates/favorite-sticker.html",controller:"LocalStickerController as stickerList"})}function t(e,t){t.addPart("favorite"),e.refresh()}angular.module("ponysticker.favorite",[]).config(e).run(t),e.$inject=["$stateProvider"],t.$inject=["$translate","$translatePartialLoader"]}(),function(){function e(e){e.state("local",{url:"/local/:type",templateUrl:"templates/local.html",controller:"LocalController as local",resolve:{type:PonyModule.resolveParamFactory("type")}}).state("local.package",{url:"/package",templateUrl:"templates/local-package.html",controller:"LocalPackageController as package"}).state("local.sticker",{url:"/sticker",templateUrl:"templates/local-sticker.html",controller:"LocalStickerController as stickerList"})}function t(e,t){t.addPart("local"),e.refresh()}angular.module("ponysticker.local",[]).config(e).run(t),e.$inject=["$stateProvider"],t.$inject=["$translate","$translatePartialLoader"]}(),function(){function e(e,t){t.addPart("menu"),e.refresh()}angular.module("ponysticker.menu",[]).run(e),e.$inject=["$translate","$translatePartialLoader"]}(),function(){function e(e){e.state("package",{url:"/package/:repo/:packageId",templateUrl:"templates/package.html",controller:"PackageController as package",resolve:{repo:PonyModule.resolveParamFactory("repo"),packageId:PonyModule.resolveIntParamFactory("packageId")}})}function t(e,t){t.addPart("package"),e.refresh()}angular.module("ponysticker.package",[]).config(e).run(t),e.$inject=["$stateProvider"],t.$inject=["$translate","$translatePartialLoader"]}(),function(){function e(e){e.state("preference",{url:"/preference",templateUrl:"templates/preference.html",controller:"PreferenceController as preference"})}function t(e,t){t.addPart("preference"),e.refresh()}angular.module("ponysticker.preference",[]).config(e).run(t),e.$inject=["$stateProvider"],t.$inject=["$translate","$translatePartialLoader"]}(),function(){function e(e){e.state("tags",{url:"/tags/:type/:id",templateUrl:"templates/tags.html",controller:"TagsController as tags",resolve:{type:PonyModule.resolveParamFactory("type"),id:PonyModule.resolveIntParamFactory("id")}})}function t(e,t){t.addPart("tags"),e.refresh()}angular.module("ponysticker.tags",[]).config(e).run(t),e.$inject=["$stateProvider"],t.$inject=["$translate","$translatePartialLoader"]}(),function(){function e(e,t){t.addPart("utilites"),e.refresh()}angular.module("ponysticker.utilites",[]).run(e),e.$inject=["$translate","$translatePartialLoader"]}(),function(){function e(e,t,n,o,r,a,i,c,s,u){function l(){return _.isListLoading||_.isCountLoading}function g(){return _.loadingListErr||_.loadingCountErr}function f(e){_.sortPopover.show(e)}function d(){function t(t){var n=o.show({title:t.DOWNLOAD_PAGE_TITLE,templateUrl:"templates/download-page-editor.html",scope:e,buttons:[{text:t.DOWNLOAD_CANCEL},{text:t.DOWNLOAD_OK,type:"button-positive",onTap:function(e){return i()?!0:(e.preventDefault(),void 0)}}]});n.then(function(e){e&&c()}),_.pageEditor.closeInField=function(e){13===e.keyCode&&i()&&(c(),n.close())}}function n(){return PonyModule.isPositiveInteger(_.pageEditor.newPage)}function r(){return _.pageEditor.newPage<=_.getPageCount()}function i(){return n()&&r()}function c(){_.page=_.pageEditor.newPage,w()}_.pageEditor={newPage:_.page,isPositiveInteger:n,isInRange:r,applyNewPage:c},a(["DOWNLOAD_PAGE_TITLE","DOWNLOAD_PAGE_ALERT","DOWNLOAD_CANCEL","DOWNLOAD_OK"]).then(t)}function p(){return Math.ceil(_.pkgCount/i.getPageSize())}function k(){_.page=1,C(),w()}function v(e){13===e.keyCode&&k()}function m(e){var t=e.title[i.getLanguage()];return t||(t=e.title.en),t}function E(e){var t=e.author[i.getLanguage()];return t||(t=e.author.en),t}function T(){_.page-=1,_.page<=0&&(_.page=p()),w()}function h(){_.page+=1,_.page>p()&&(_.page=1),w()}function P(){L(),I(),b(),e.$on("$ionicView.enter",y)}function y(){S()}function I(){r.fromTemplateUrl("templates/download-sort-popover.html",{scope:e}).then(function(e){_.sortPopover=e})}function b(){e.$watch(function(){return _.order},function(e){i.setOrder(e),_.page=1,w()})}function w(){_.pkgList=[],_.pkgTabList=[],_.isListLoading=!0,c.getPkgList(_.repo,_.page,i.getPageSize(),_.order,_.query).success(function(e){_.isListLoading=!1,_.loadingListErr=!1,_.pkgList=e,S(),n.scrollTop()}).error(function(){_.isListLoading=!1,_.loadingListErr=!0})}function S(){_.pkgList.forEach(function(e,t){s.getMeta("package",e.packageId).success(function(n){_.pkgTabList[t]=n?c.getTabOffUrl(e.packageId):c.getTabOnUrl(e.packageId)}).error(function(){_.pkgTabList[t]=c.getTabOnUrl(e.packageId)})})}function C(){_.isCountLoading=!0,c.getPkgCount(_.repo,_.query).success(function(e){_.isCountLoading=!1,_.loadingCountErr=!1,_.pkgCount=e}).error(function(){_.isCountLoading=!1,_.loadingCountErr=!0})}function L(){C(),w()}var _=this;_.repo=u,_.order=i.getOrder(),_.pkgCount=0,_.page=1,_.pkgList=[],_.pkgTabList=[],_.query="",_.getPageCount=p,_.search=k,_.getTitle=m,_.getAuthor=E,_.goPrev=T,_.goNext=h,_.searchInField=v,_.showPageEditor=d,_.showSortPopover=f,_.refreshAll=L,_.isLoading=l,_.isLoadingErr=g,P()}angular.module("ponysticker.download").controller("DownloadController",e),e.$inject=["$scope","$state","$ionicScrollDelegate","$ionicPopup","$ionicPopover","$translate","preference","serverAPI","database","repo"]}(),function(){function e(e,t){function n(t,n){return e.get(s("sticker"),{params:{pkg:t,sticker:n,base64:"1"}})}function o(t,n){return e.get(s("meta"),{params:{repo:t,pkg:n}})}function r(e){return s("sticker")+"?"+$.param([{name:"pkg",value:e},{name:"sticker",value:"tab_on"}])}function a(e){return s("sticker")+"?"+$.param([{name:"pkg",value:e},{name:"sticker",value:"tab_off"}])}function i(t,n){return e.get(s("pkg-count"),{params:{repo:t,q:n}})}function c(t,n,o,r,a){return e.get(s("pkg-list"),{params:{repo:t,page:n,size:o,order:r,q:a}})}function s(e){var n=t.getServer();return"/"!==n.slice(-1)?n+"/"+e:n+e}var u=this;u.getMeta=o,u.getTabOnUrl=r,u.getTabOffUrl=a,u.getStickerBase64=n,u.getPkgCount=i,u.getPkgList=c}angular.module("ponysticker.download").service("serverAPI",e),e.$inject=["$http","preference"]}(),function(){function e(e,t,n,o){function r(e){return u.itemImgs[e]?"data:image/jpg;base64,"+u.itemImgs[e]:""}function a(){c(),e.$on("$ionicView.enter",i)}function i(){c()}function c(){t.getMetaPaginationByStar(u.type,u.page,u.pageSize).success(function(e){u.items=e,s()}).error(function(){})}function s(){var e;e="package"===u.type?"packageId":"id",u.items.forEach(function(n){t.getImg(u.type,n[e]).success(function(t){u.itemImgs[n[e]]=t.base64}).error(function(){})})}var u=this;u.page=1,u.pageSize=n.getPageSize(),u.type=o,u.items=[],u.itemImgs={},u.getItemImgUrl=r,a()}angular.module("ponysticker.favorite").controller("FavoriteController",e),e.$inject=["$scope","database","preference","type"]}(),function(){function e(e,t,n,o,r,a,i){function c(){a.getMetasPagination(y.type,y.page+1,y.pageSize).success(function(n){var o=y.items.length;y.items=y.items.concat(n[0]),E(o),y.hasNext=n[1],y.page+=1,t(function(){e.$broadcast("scroll.infiniteScrollComplete")},100)}).error(function(){})}function s(e){return y.itemImgs[e]?"data:image/jpg;base64,"+y.itemImgs[e]:""}function u(e){return"package"===y.type?e.packageId:e.id}function l(){for(var e in y.selected)y.selected.hasOwnProperty(e)&&(y.unselected[e]=!0,delete y.selected[e])}function g(e){y.selected[e]=!0,delete y.unselected[e],m(!0),o.$getByHandle("modalContent").scrollTop(!0)}function f(e){y.unselected[e]=!0,delete y.selected[e],m(!0)}function d(){y.tagModal.show()}function p(e){return Object.keys(e)}function k(){h(),e.$on("$ionicView.enter",v)}function v(){m(!0)}function m(e){o.$getByHandle("mainContent").scrollTop(!0),$.isEmptyObject(y.selected)?a.getMetasPagination(y.type,1,y.page*y.pageSize).success(function(t){y.items=t[0],y.hasNext=t[1],E(0),e&&T()}).error(function(){}):a.getMetasWithTags(y.type,y.selected).success(function(t){y.items=t,y.hasNext=!1,E(0),e&&T()}).error(function(){})}function E(e){var t;t="package"===y.type?"packageId":"id",y.items.slice(e).forEach(function(e){a.getImg(y.type,e[t]).success(function(n){y.itemImgs[e[t]]=n.base64}).error(function(){})})}function T(){if($.isEmptyObject(y.selected))P();else{var e=y.items.map(function(e){return"package"===y.type?e.packageId:e.id});a.getTagsWithIds(y.type,e,y.selected).success(function(e){y.unselected=e}).error(function(){})}}function h(){n.fromTemplateUrl("templates/local-tags.html",{scope:e,animation:"slide-in-up"}).then(function(e){y.tagModal=e})}function P(){a.getAllTags(y.type,[]).success(function(e){y.unselected=e}).error(function(){})}var y=this;y.type=i,y.selected={},y.unselected={},y.page=1,y.hasNext=!1,y.pageSize=r.getPageSize(),y.query="",y.items=[],y.itemImgs={},y.showTagModal=d,y.addTag=g,y.deleteTag=f,y.clearTags=l,y.getKeys=p,y.getItemId=u,y.getItemImgUrl=s,y.loadMore=c,k()}angular.module("ponysticker.local").controller("LocalController",e),e.$inject=["$scope","$timeout","$ionicModal","$ionicScrollDelegate","preference","database","type"]}(),function(){function e(e){function t(t){return t.title[e.getLanguage()]||t.title.en}function n(t){return t.author[e.getLanguage()]||t.title.en}var o=this;o.getTitle=t,o.getAuthor=n}angular.module("ponysticker.local").controller("LocalPackageController",e),e.$inject=["preference"]}(),function(){function e(e){function t(t,n){e(t.id,!0,n)}var n=this;n.showActionSheet=t}angular.module("ponysticker.local").controller("LocalStickerController",e),e.$inject=["stickerActionSheet"]}(),function(){function e(){function e(){window.close(),ionic.Platform.exitApp()}function t(e){o.submenu=o.submenu!==e?e:""}function n(e){return o.submenu===e}var o=this;o.submenu="",o.toggleSubmenu=t,o.showSubmenu=n,o.exitApp=e,o.isWebView=ionic.Platform.isWebView}angular.module("ponysticker.menu").controller("MenuController",e)}(),function(){function e(e,t,n,o,r,a,i,c,s,u,l,g,f,d,p){function k(){N.morePopover.hide(),u.auth().then(function(){e.loading={},n.show({scope:e,templateUrl:"templates/loading.html"}),l.exportPackage(N.packageId).then(function(e){var t=new Date,o="package"+N.packageId+"-"+t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+"-"+t.getHours()+"."+t.getMinutes()+"."+t.getSeconds()+".json";u.uploadJson(o,e,function(e){n.hide(),e.title||v()})},function(){v()})},function(){v()})}function v(){i(["PACKAGE_EXPORT_ALERT_TITLE","PACKAGE_EXPORT_ALERT_CONTENT"]).then(function(e){o.alert({title:e.PREFERENCE_EXPORT_ALERT_TITLE,template:e.PREFERENCE_EXPORT_ALERT_CONTENT})})}function m(e){c(e,!1,N.stickersBase64[e],N.remote)}function E(e){N.morePopover.show(e)}function T(){function e(e){o.confirm({title:e.PACKAGE_DELETE_TITLE,template:e.PACKAGE_DELETE_CONTENT,cancelText:e.PACKAGE_DELETE_CANCEL,okText:e.PACKAGE_DELETE_CONFIRM,okType:"button-assertive"}).then(function(e){e&&f.deletePackage(N.packageId).success(function(){N.remote=!0,N.favorite=!1}).error(function(){})})}i(["PACKAGE_DELETE_TITLE","PACKAGE_DELETE_CONTENT","PACKAGE_DELETE_CANCEL","PACKAGE_DELETE_CONFIRM"]).then(e)}function h(){N.meta.star=1,f.updateMeta("package",N.meta).success(function(){N.favorite=!0}).error(function(){})}function P(){N.meta.star=0,f.updateMeta("package",N.meta).success(function(){N.favorite=!1}).error(function(){})}function y(){var e=0;return N.tabOnBase64&&(e+=1),e+PonyModule.objSize(N.stickersBase64)}function I(){N.isShowAll=!0}function b(){function e(){t(function(){y()<N.meta.stickers.length+1?e():f.addPackage(N.meta,N.tabOnBase64,N.stickersBase64).success(function(){N.isDownloading=!1,N.remote=!1}).error(function(){})},500)}N.isDownloading=!0,e()}function w(e){return N.stickersBase64[e]?D+N.stickersBase64[e]:""}function S(){if(!N.meta)return"";var e=N.meta.title[s.getLanguage()];return e||(e=N.meta.title.en),e}function C(){if(!N.meta)return"";var e=N.meta.author[s.getLanguage()];return e||(e=N.meta.author.en),e}function L(){return N.tabOnBase64?D+N.tabOnBase64:""}function _(){O(),f.getMeta("package",N.packageId).success(function(e){N.meta=e,N.meta?(N.remote=!1,N.favorite=N.meta.star,$(),R()):(N.remote=!0,j())}).error(function(){})}function R(){f.getImg("package",N.packageId).success(function(e){N.tabOnBase64=e.base64}).error(function(){})}function O(){N.morePopover=r.fromTemplateUrl("templates/package-more-popover.html",{scope:e}).then(function(e){N.morePopover=e})}function $(){N.meta.stickers.forEach(function(e){f.getImg("sticker",e).success(function(t){N.stickersBase64[e]=t.base64}).error(function(){})})}function j(){g.getMeta(d,p).success(function(e){N.meta=e,A(),M()}).error(function(){N.hasError=!0})}function A(){g.getStickerBase64(N.packageId,"tab_on").success(function(e){N.tabOnBase64=e}).error(function(){N.tabOnBase64=0,N.hasError=!0})}function M(){N.meta.stickers.forEach(function(e){g.getStickerBase64(N.packageId,e).success(function(t){N.stickersBase64[e]=t}).error(function(){N.stickersBase64[e]=0,N.hasError=!0})})}var N=this,D="data:image/jpg;base64,";N.repo=d,N.packageId=p,N.remote=!1,N.favorite=!1,N.stickersBase64={},N.isShowAll=!1,N.hasError=!1,N.stickers=[],N.stickerIdx=0,N.hasMore=!0,N.getTabOnUrl=L,N.getStickerUrl=w,N.getTitle=S,N.getAuthor=C,N.showAll=I,N.download=b,N.progress=y,N.addFavorite=h,N.removeFavorite=P,N.deletePackage=T,N.showMorePopover=E,N.showActionSheet=m,N.exportPackage=k,_()}angular.module("ponysticker.package").controller("PackageController",e),e.$inject=["$scope","$timeout","$ionicLoading","$ionicPopup","$ionicPopover","$state","$translate","stickerActionSheet","preference","googledrive","backup","serverAPI","database","repo","packageId"]}(),function(){function e(e,t,n,o,r){function a(t){function n(e){var t=s.get(e);t.onsuccess=function(e){var t=e.target.result;console.log(t),t.tag=[];var n=window.IDBKeyRange.only(t.id),o=l.index("id").openCursor(n);o.onsuccess=function(e){var n=e.target.result;n?(t.tag.push(n.value.tag),n.continue()):a.sticker.push(t)}}}var r=e.defer(),a={};a.version=2;var i=o.db.transaction(["package","sticker","packageTag","stickerTag"]),c=i.objectStore("package"),s=i.objectStore("sticker"),u=i.objectStore("packageTag"),l=i.objectStore("stickerTag");a.package=[];var g=c.get(t);return g.onsuccess=function(e){var t=e.target.result;t.tag=[];var o=window.IDBKeyRange.only(t.packageId),r=u.index("id").openCursor(o);r.onsuccess=function(e){var o=e.target.result;o?(t.tag.push(o.value.tag),o.continue()):(a.package.push(t),a.sticker=[],t.stickers.forEach(function(e){n(e)}))}},i.oncomplete=function(){r.resolve(a)},i.onerror=function(e){r.reject(e)},r.promise}function i(){function t(){r.sticker=[];var e=c.openCursor();e.onsuccess=function(e){var t=e.target.result;if(t){var n=t.value;n.tag=[];var o=window.IDBKeyRange.only(n.id),a=u.index("id").openCursor(o);a.onsuccess=function(e){var o=e.target.result;o?(n.tag.push(o.value.tag),o.continue()):(r.sticker.push(n),t.continue())}}}}var n=e.defer(),r={};r.version=2;var a=o.db.transaction(["package","sticker","packageTag","stickerTag"]),i=a.objectStore("package"),c=a.objectStore("sticker"),s=a.objectStore("packageTag"),u=a.objectStore("stickerTag");r.package=[];var l=i.openCursor();return l.onsuccess=function(e){var n=e.target.result;if(n){var o=n.value;o.tag=[];var a=window.IDBKeyRange.only(o.packageId),i=s.index("id").openCursor(a);i.onsuccess=function(e){var t=e.target.result;t?(o.tag.push(t.value.tag),t.continue()):(r.package.push(o),n.continue())}}else t()},a.oncomplete=function(){n.resolve(r)},a.onerror=function(e){n.reject(e)},n.promise}function c(n,a){function i(e,n){t(function(){d?e.apply(this,n):i(e,n)},1)}function c(e){function i(){o.getMeta("package",e.packageId).success(function(e){e?(P=e,c()):(u(),v())}).error(function(){S=!0,h()})}function c(){P.star=e.star,o.updateMeta("package",P).success(function(){h()}).error(function(){S=!0,h()})}function u(){r.getMeta(w,e.packageId).success(function(e){P=e,g(),k()}).error(function(){S=!0})}function g(){r.getStickerBase64(e.packageId,"tab_on").success(function(e){y=e}).error(function(){S=!0})}function k(){P.stickers.forEach(function(t){r.getStickerBase64(e.packageId,t).success(function(e){I[t]=e,b+=1}).error(function(){S=!0})})}function v(){t(function(){P&&y&&b===P.stickers.length?(P.star=e.star,m()):S?h():v()},1)}function m(){o.addPackage(P,y,I).success(function(){E()}).error(function(){S=!0,h()})}function E(){o.getTagsWithIds("package",[e.packageId],[]).success(function(e){C=e,T()}).error(function(){S=!0,h()})}function T(){if(e.tags=[],Array.isArray(e.tag)?e.tags=e.tag:e.tag&&(e.tags=e.tag.split(" ")),e.tags.length<=0)return h(),void 0;var t=e.tags.length,n=0;e.tags.forEach(function(r){C[r]?--t===n&&h():o.addTag(r,"package",e.packageId).success(function(){++n===t&&h()}).error(function(){S=!0,h()})})}function h(){d=!0,p=S,++a.loading.complete===n.package.length&&s()}if(1===f&&e.packageId>=5e6)return a.loading.complete+=1,void 0;d=!1;var P=null,y=null,I={},b=0,w=l(e.packageId),S=!1,C=null;i()}function s(){a.loading.stickerComplete=0,a.loading.stickerTotal=n.sticker.length,n.sticker.forEach(function(e){u(e)})}function u(e){function t(){o.getMeta("sticker",e.id).success(function(e){e?(u=e,n()):c()}).error(function(){s=!0,c()})}function n(){o.getTagsWithIds("sticker",[e.id],[]).success(function(e){l=e,r()}).error(function(){s=!0,c()})}function r(){u.recent=e.recent,void 0===u.recent&&(u.recent=e.time),u.star=e.star,o.updateMeta("sticker",u).success(function(){i()}).error(function(){s=!0,c()})}function i(){if(e.tags=[],Array.isArray(e.tag)?e.tags=e.tag:e.tag&&(e.tags=e.tag.split(" ")),e.tags.length<=0)return c(),void 0;var t=e.tags.length,n=0;e.tags.forEach(function(r){l[r]?--t===n&&c():o.addTag(r,"sticker",e.id).success(function(){++n===t&&c()}).error(function(){s=!0,c()})})}function c(){s&&(p=s),++a.loading.stickerComplete===a.loading.stickerTotal&&g.resolve(p)}var s=!1,u=null,l=null;t()}function l(e){return 0>e?"custom":1e6>e?"official":"creator"}var g=e.defer(),f=n.version,d=!0,p=!1;return a.loading.complete=0,a.loading.total=n.package.length,f||(f=1),n.package.forEach(function(e,t){i(c,[e,t])}),g.promise}var s=this;s.importData=c,s.exportData=i,s.exportPackage=a}angular.module("ponysticker.preference").service("backup",e),e.$inject=["$q","$timeout","$ionicLoading","database","serverAPI"]}(),function(){function e(e,t,n,o,r,a){function i(){function e(){window.gapi.auth.authorize({client_id:u,scope:g,immediate:!0},function(e){e&&!e.error?l.resolve():window.gapi.auth.authorize({client_id:u,scope:g,immediate:!1},function(e){e&&!e.error?l.resolve():l.reject(e.error)})})}function t(){var e=window.gapi.auth.getToken()||a.getDriveToken();e&&e.access_token?n.get("https://www.googleapis.com/oauth2/v1/tokeninfo",{params:{access_token:e.access_token}}).success(function(t){t&&!t.error?(a.setDriveToken(e),window.gapi.auth.setToken(e),l.resolve()):i()}).error(function(){i()}):i()}function i(){r.google(u,[g]).then(function(e){e&&!e.error?(a.setDriveToken(e),window.gapi.auth.setToken(e),l.resolve()):l.reject(e.error)},function(e){l.reject(e.error)})}function s(){ionic.Platform.isWebView()?c(t):c(e)}var l=o.defer();return window.gapi?s():$.getScript("https://apis.google.com/js/client.js?onload=handleClientLoad",s),l.promise}function c(e,n){t(function(){window.gapi&&window.gapi.auth?e(n):c(e,n)},1)}function s(e,n,o){function r(){function t(){var e=window.gapi.client.request({path:"/upload/drive/v2/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+r+'"'},body:l});o||(o=function(e){console.log(e)}),e.execute(o)}var r="-------314159265358979323846",i="\r\n--"+r+"\r\n",c="\r\n--"+r+"--",s="application/json",u={title:e,mimeType:s},l=i+"Content-Type: application/json\r\n\r\n"+JSON.stringify(u)+i+"Content-Type: "+s+"\r\n\r\n"+JSON.stringify(n)+c;a(t)}function a(e,n){t(function(){window.gapi&&window.gapi.client?e(n):a(e,n)},100)}window.gapi?r():$.getScript("https://apis.google.com/js/client.js?onload=handleClientLoad",r)}var u,l=this;e.ready(function(){u=ionic.Platform.isWebView()?"826702538511-4ue3qu71ujbga5qa5id8s7k76k1ssq3e.apps.googleusercontent.com":"826702538511-cgmsl0n36bekvihgl1pb7smv9hj1r5n3.apps.googleusercontent.com"});var g="https://www.googleapis.com/auth/drive";l.auth=i,l.uploadJson=s}angular.module("ponysticker.preference").service("googledrive",e),e.$inject=["$ionicPlatform","$timeout","$http","$q","$cordovaOauth","preference"]}(),function(){function e(e,t,n,o,r,a,i,c){function s(){function o(){c.auth().then(function(){e.loading={},n.show({scope:e,templateUrl:"templates/loading.html"}),i.exportData().then(function(e){var t=new Date,o="database-"+t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+"-"+t.getHours()+"."+t.getMinutes()+"."+t.getSeconds()+".json";c.uploadJson(o,e,function(e){n.hide(),e.title||u()})},function(){n.hide(),u()})},function(){u()})}r(["PREFERENCE_EXPORT_ALERT_TITLE","PREFERENCE_EXPORT_ALERT_CONTENT"]).then(function(e){t.confirm({title:e.PREFERENCE_EXPORT_ALERT_TITLE,template:e.PREFERENCE_EXPORT_ALERT_CONTENT}).then(function(e){e&&o()})})}function u(){r(["PREFERENCE_EXPORT_ERROR_TITLE","PREFERENCE_EXPORT_ERROR_CONTENT"]).then(function(e){t.alert({title:e.PREFERENCE_EXPORT_ERROR_TITLE,template:e.PREFERENCE_EXPORT_ERROR_CONTENT})})}function l(){function o(){var o=new FileReader;o.onload=function(o){var a=JSON.parse(o.target.result);e.loading={},n.show({scope:e,templateUrl:"templates/loading.html"}),i.importData(a,e).then(function(e){n.hide(),e&&r(["PREFERENCE_IMPORT_ERROR_TITLE","PREFERENCE_IMPORT_ERROR_CONTENT"]).then(function(e){t.alert({title:e.PREFERENCE_IMPORT_ERROR_TITLE,template:e.PREFERENCE_IMPORT_ERROR_CONTENT})})})},o.readAsText(v.uploaded[0])}r(["PREFERENCE_IMPORT_ALERT_TITLE","PREFERENCE_IMPORT_ALERT_CONTENT"]).then(function(e){t.confirm({title:e.PREFERENCE_IMPORT_ALERT_TITLE,template:e.PREFERENCE_IMPORT_ALERT_CONTENT}).then(function(e){e&&o()})})}function g(){k()}function f(){a.setLanguage(v.language),r.use(v.language)}function d(){a.setServer(v.server)}function p(){a.setPageSize(v.pageSize),o.clearCache()}function k(){return ionic.Platform.isWebView()?void 0:navigator.webkitTemporaryStorage?(navigator.webkitTemporaryStorage.queryUsageAndQuota(function(e,t){v.usedMB=parseInt(e/1024/1024),v.totalMB=parseInt((t+e)/1024/1024)},function(){}),void 0):window.webkitStorageInfo?(window.webkitStorageInfo.queryUsageAndQuota(window.webkitStorageInfo.TEMPORAR,function(e,t){v.usedMB=parseInt(e/1024/1024),v.totalMB=parseInt((t+e)/1024/1024)},function(){}),void 0):(ionic.Platform.isIOS()&&(v.usedMB="unknown",v.totalMB="50"),void 0)}var v=this;v.language=a.getLanguage(),v.pageSize=a.getPageSize(),v.server=a.getServer(),v.uploaded=null,v.updateLanguage=f,v.updatePageSize=p,v.updateServer=d,v.change=l,v.exportData=s,g()}angular.module("ponysticker.preference").controller("PreferenceController",e),e.$inject=["$scope","$ionicPopup","$ionicLoading","$ionicHistory","$translate","preference","backup","googledrive"]}(),function(){function e(e,t,n,o,r){function a(e){return Object.keys(e)}function i(e){n.addTag(e,g.type,g.id).success(function(){delete g.unselected[e],g.selected[e]=!0}).error(function(){})}function c(e){n.deleteTag(e,g.type,g.id).success(function(){delete g.selected[e],g.unselected[e]=!0}).error(function(){})}function s(){g.query&&!g.selected[g.query]&&n.addTag(g.query,g.type,g.id).success(function(){g.selected[g.query]=!0,delete g.unselected[g.query],g.query=""}).error(function(){})}function u(e){13===e.keyCode&&s()}function l(){n.getClassifiedTags(g.type,g.id).success(function(e){g.selected=e[0],g.unselected=e[1]}).error(function(){})}var g=this;g.type=o,g.id=r,g.unselected={},g.selected={},g.query="",g.addTag=i,g.deleteTag=c,g.addTagDirectly=s,g.addTagInField=u,g.getKeys=a,l()}angular.module("ponysticker.tags").controller("TagsController",e),e.$inject=["$ionicPopup","$translate","database","type","id"]}(),function(){function e(){return{restrict:"A",link:function(e,t,n){n.$observe("backgroundSrc",function(e){t.css({"background-image":'url("'+e+'")'})})}}}angular.module("ponysticker.utilites").directive("backgroundSrc",e)}(),function(){function e(e,t){function n(t){var n=e.defer();return v(function(){var e,o=L.only(1);e=h.db.transaction([t],"readonly").objectStore(t).index("star").openCursor(o),e.onerror=function(e){n.reject(e)};var r=[];e.onsuccess=function(e){var t=e.target.result;t?(r.push(t.value),t.continue()):n.resolve(r)}}),E(n.promise)}function o(t,n){var o=e.defer(),r=Object.keys(n);return v(function(){var e=h.db.transaction([t+"Tag"],"readonly"),n=e.objectStore(t+"Tag"),a=[];r.forEach(function(e,t){a[t]={};var o=L.only(e),r=n.index("tag").openCursor(o);r.onsuccess=function(e){var n=e.target.result;n&&(a[t][n.value.id]=!0,n.continue())}}),e.onerror=function(e){o.reject(e)},e.oncomplete=function(){for(var e=a[0],n=1;n<a.length;n+=1)e=PonyModule.objIntersection(e,a[n]);var r=h.db.transaction([t],"readonly"),i=r.objectStore(t),c=[];for(var s in e)if(e.hasOwnProperty(s)){var u=parseInt(s);i.get(u).onsuccess=function(e){c.push(e.target.result)}}r.onerror=function(e){o.reject(e)},r.oncomplete=function(){o.resolve(c)}}}),E(o.promise)}function r(t,n,o){var r=e.defer();return v(function(){var e;e="sticker"===t?h.db.transaction(["sticker"],"readonly").objectStore("sticker").index("recent").openCursor(null,"prev"):h.db.transaction([t],"readonly").objectStore(t).openCursor(),e.onerror=function(e){r.reject(e)};var a=0,i=[],c=!0,s=!0;e.onsuccess=function(e){var t=e.target.result;t?c?(1===n?(i.push(t.value),a+=1,t.continue()):t.advance((n-1)*o),c=!1):o>a?(i.push(t.value),a+=1,t.continue()):r.resolve([i,s]):(s=!1,r.resolve([i,s]))}}),E(r.promise)}function a(t,n,o){var r=e.defer();return v(function(){var e=h.db.transaction([t+"Tag"],"readonly"),a=e.objectStore(t+"Tag"),i=[];n.forEach(function(e,t){i[t]={};var n=L.only(e),r=a.index("id").openCursor(n);r.onsuccess=function(e){var n=e.target.result;if(n){var r=n.value.tag;o[r]||(i[t][r]=!0),n.continue()}}}),e.onerror=function(e){r.reject(e)},e.oncomplete=function(){for(var e=i[0],t=1;t<i.length;t+=1)e=PonyModule.objUnionInPlace(e,i[t]);r.resolve(e)}}),E(r.promise)}function i(t){var n=t+"Tag",o=e.defer();return v(function(){var e=h.db.transaction([n],"readonly").objectStore(n).openCursor();e.onerror=function(e){o.reject(e)};var t={};e.onsuccess=function(e){var n=e.target.result;n?(t[n.value.tag]=!0,n.continue()):o.resolve(t)}}),E(o.promise)}function c(t,n){var o=t+"Tag",r=e.defer();return v(function(){var e=h.db.transaction([o],"readonly").objectStore(o).openCursor();e.onerror=function(e){r.reject(e)};var t={},a={};e.onsuccess=function(e){var o=e.target.result;if(o)o.value.id===n?t[o.value.tag]=!0:a[o.value.tag]=!0,o.continue();else{for(var i in t)t.hasOwnProperty(i)&&delete a[i];r.resolve([t,a])}}}),E(r.promise)}function s(t,n,o){var r=n+"Tag",a=e.defer();return v(function(){var e=L.only(o),n=h.db.transaction([r],"readwrite"),i=n.objectStore(r),c=i.index("id").openCursor(e);c.onsuccess=function(e){var n=e.target.result;if(n)n.value.tag!==t&&n.continue();else{i.put({tag:t,id:o})}},n.oncomplete=function(e){a.resolve(e)},n.onerror=function(e){a.reject(e)}}),E(a.promise)}function u(t,n,o){var r=n+"Tag",a=e.defer();return v(function(){var e=L.only(o),n=h.db.transaction([r],"readwrite"),i=n.objectStore(r),c=i.index("id").openCursor(e);c.onsuccess=function(e){var n=e.target.result;if(n)if(n.value.tag===t){i.delete(n.primaryKey)}else n.continue()},n.oncomplete=function(e){a.resolve(e)},n.onerror=function(e){a.reject(e)}}),E(a.promise)}function l(t){var n=e.defer();return v(function(){var e=h.db.transaction(["package","sticker","packageTag","stickerTag","packageImg","stickerImg"],"readwrite"),o=e.objectStore("package"),r=e.objectStore("sticker"),a=e.objectStore("packageTag"),i=e.objectStore("stickerTag"),c=e.objectStore("packageImg"),s=e.objectStore("stickerImg"),u=o.get(t);u.onsuccess=function(e){var t=e.target.result;t.stickers.forEach(function(e){var t=L.only(e),n=i.index("id").openCursor(t);n.onsuccess=function(e){var t=e.target.result;t&&(i.delete(t.primaryKey),t.continue())},s.delete(e),r.delete(e)})};var l=L.only(t),g=a.index("id").openCursor(l);g.onsuccess=function(e){var t=e.target.result;t&&(a.delete(t.primaryKey),t.continue())},c.delete(t),o.delete(t),e.oncomplete=function(e){n.resolve(e)},e.onerror=function(e){n.reject(e)}}),E(n.promise)}function g(t,n){var o=e.defer();return v(function(){var e=h.db.transaction(t,"readwrite").objectStore(t).put(n);e.onsuccess=function(e){o.resolve(e)},e.onerror=function(e){o.reject(e)}}),E(o.promise)}function f(t,n){var o=e.defer();return v(function(){var e=h.db.transaction(t+"Img").objectStore(t+"Img").get(n);e.onsuccess=function(e){o.resolve(e.target.result)},e.onerror=function(e){o.reject(e)}}),E(o.promise)}function d(t,n){var o=e.defer();return v(function(){var e=h.db.transaction(t).objectStore(t).get(n);e.onsuccess=function(e){o.resolve(e.target.result)},e.onerror=function(e){o.reject(e)
}}),E(o.promise)}function p(t,n,o){var r=e.defer();return k(function(){var e=h.db.transaction(["package","sticker","packageImg","stickerImg"],"readwrite"),a=e.objectStore("package"),i=e.objectStore("packageImg");t.date=Date.now(),void 0===t.star&&(t.star=0),a.add(t),i.add({packageId:t.packageId,base64:n});var c=e.objectStore("sticker"),s=e.objectStore("stickerImg");for(var u in o)if(o.hasOwnProperty(u)){var l={id:parseInt(u),packageId:t.packageId,recent:0,star:0};c.add(l),s.add({id:l.id,base64:o[u]})}e.oncomplete=function(e){r.resolve(e)},e.onerror=function(e){r.reject(e)}}),E(r.promise)}function k(e){t(function(){m()?e():k(e)},200)}function v(e){m()?e():k(e)}function m(){return P&&y&&I&&b&&w&&S}function E(e){return e.success=function(t){return e.then(function(e){t(e)}),e},e.error=function(t){return e.then(null,function(e){t(e)}),e},e}function T(){ionic.Platform.isWebView()||ionic.Platform.isIOS()||PonyModule.isSafari()?(window.shimIndexedDB.__useShim(),C=window._indexedDB||window.indexedDB,L=window._IDBKeyRange||window.IDBKeyRange):(C=window.indexedDB||window._indexedDB,L=window.IDBKeyRange||window._IDBKeyRange);var e=C.open("ponyDB",h.dbVersion);e.onupgradeneeded=function(e){if(h.db=e.target.result,e.oldVersion<1){var t=h.db.createObjectStore("package",{keyPath:"packageId"});t.createIndex("date","date",{unique:!1}),t.createIndex("star","star",{unique:!1}),t.transaction.oncomplete=function(){P=!0},t.transaction.onerror=function(){};var n=h.db.createObjectStore("packageTag",{autoIncrement:!0});n.createIndex("tag","tag",{unique:!1}),n.createIndex("id","id",{unique:!1}),n.transaction.oncomplete=function(){I=!0},n.transaction.onerror=function(){};var o=h.db.createObjectStore("packageImg",{keyPath:"packageId"});o.transaction.oncomplete=function(){w=!0},o.transaction.onerror=function(){};var r=h.db.createObjectStore("sticker",{keyPath:"id"});r.createIndex("packageId","packageId",{unique:!1}),r.createIndex("recent","recent",{unique:!1}),r.createIndex("star","star",{unique:!1}),r.transaction.oncomplete=function(){y=!0},r.transaction.onerror=function(){};var a=h.db.createObjectStore("stickerTag",{autoIncrement:!0});a.createIndex("tag","tag",{unique:!1}),a.createIndex("id","id",{unique:!1}),a.transaction.oncomplete=function(){b=!0},a.transaction.onerror=function(){};var i=h.db.createObjectStore("stickerImg",{keyPath:"id"});i.transaction.oncomplete=function(){S=!0},i.transaction.onerror=function(){}}},e.onsuccess=function(e){P=!0,y=!0,I=!0,b=!0,w=!0,S=!0,h.db=e.target.result},e.onerror=function(){}}var h=this,P=!1,y=!1,I=!1,b=!1,w=!1,S=!1,C=null,L=null;h.dbVersion=1,h.init=T,h.addPackage=p,h.deletePackage=l,h.updateMeta=g,h.getMeta=d,h.addTag=s,h.deleteTag=u,h.getClassifiedTags=c,h.getAllTags=i,h.getTagsWithIds=a,h.getMetasPagination=r,h.getMetasWithTags=o,h.getMetaPaginationByStar=n,h.getImg=f}angular.module("ponysticker.utilites").service("database",e),e.$inject=["$q","$timeout"]}(),function(){function e(){function e(e,t){return function(){var n=JSON.parse(localStorage.getItem(e));return n||(n=t),n}}function t(e){return function(t){localStorage.setItem(e,JSON.stringify(t))}}function n(e){return function(t){localStorage.setItem(e,t)}}function o(e,t){return function(){var n=localStorage.getItem(e);return n||(n=t),n}}var r=this;r.setLanguage=n("language"),r.getLanguage=o("language","en"),r.setServer=n("server"),r.getServer=o("server","http://1.34.244.41:50025"),r.setPageSize=n("pageSize"),r.getPageSize=o("pageSize",12),r.setOrder=n("order"),r.getOrder=o("order","packageId"),r.setDatabaseVersion=n("dbversion"),r.getDatabaseVersion=o("dbversion",0),r.setDriveToken=t("driveToken"),r.getDriveToken=e("driveToken",null)}angular.module("ponysticker.utilites").service("preference",e)}(),function(){function e(){return{restrict:"A",scope:{isOpen:"=slideToggle"},link:function(e,t,n){var o=parseInt(n.slideToggleDuration,10)||400;e.$watch("isOpen",function(e,n){e!==n&&t.stop().slideToggle(o)})}}}angular.module("ponysticker.utilites").directive("slideToggle",e)}(),function(){function e(e,t,n,o,r){function a(t,n,o){o||(t.recent=Date.now(),r.updateMeta("sticker",t)),"main"===e.intentType?window.PonyPlugin.shareWithBase64(n):"browser"===e.intentType?window.open("data:image/jpg;base64,"+n,"_blank"):window.PonyPlugin.setResultWithBase64(n)}function i(e){e.star=0===e.star?1:0,r.updateMeta("sticker",e).error(function(){})}function c(e){n.go("tags",{type:"sticker",id:e.id})}function s(e){n.go("package",{repo:"local",packageId:e.packageId})}return function(e,n,u,l){o(["UTILITES_SET_TAGS","UTILITES_CANCEL","UTILITES_SHARE_STICKER","UTILITES_ADD_FAVORITE","UTILITES_REMOVE_FAVORITE","UTILITES_JUMP_TO_PACKAGE"]).then(function(o){r.getMeta("sticker",e).success(function(e){var r=e,g=[];g.push({text:o.UTILITES_SHARE_STICKER}),r&&(r.star?g.push({text:o.UTILITES_REMOVE_FAVORITE}):g.push({text:o.UTILITES_ADD_FAVORITE}),g.push({text:o.UTILITES_SET_TAGS}),n&&g.push({text:o.UTILITES_JUMP_TO_PACKAGE})),t.show({buttons:g,cancelText:o.UTILITES_CANCEL,buttonClicked:function(e){switch(e){case 0:a(r,u,l);break;case 1:i(r);break;case 2:c(r);break;case 3:s(r)}return!0}})}).error(function(){})})}}angular.module("ponysticker.utilites").factory("stickerActionSheet",e),e.$inject=["$rootScope","$ionicActionSheet","$state","$translate","database"]}(),function(){function e(){return{restrict:"A",link:function(e,t){t.bind("touchstart",function(){t.addClass("touch-active")}),t.bind("touchend",function(){t.removeClass("touch-active")})}}}angular.module("ponysticker.utilites").directive("touchActive",e)}();